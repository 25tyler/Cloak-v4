<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spacing Test - Encryption</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Georgia', serif;
            line-height: 1.8;
            color: #2c3e50;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .content {
            padding: 40px;
        }
        
        .test-section {
            margin-bottom: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .test-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        
        .test-section p {
            margin-bottom: 15px;
            font-size: 1.1em;
            line-height: 1.8;
            /* Prevent breaking words in the middle */
            word-break: normal;
            overflow-wrap: normal;
            word-wrap: normal;
        }
        
        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #28a745;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-weight: bold;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .status.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .status.error {
            background: #dc3545;
        }
        
        .status.info {
            background: #17a2b8;
        }
        
        .key-display {
            background: #e9ecef;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 1.2em;
            text-align: center;
            color: #495057;
        }
        
        .spacing-test {
            background: white;
            padding: 20px;
            border-radius: 6px;
            margin-top: 15px;
            border: 2px dashed #dee2e6;
        }
        
        .spacing-test strong {
            color: #667eea;
        }
        
        .mappings-display {
            background: white;
            padding: 20px;
            border-radius: 6px;
            margin-top: 15px;
            border: 2px solid #667eea;
        }
        
        .mappings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .mapping-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }
        
        .mapping-group h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .mapping-item {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            padding: 3px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .mapping-item:last-child {
            border-bottom: none;
        }
        
        .mapping-char {
            display: inline-block;
            width: 30px;
            font-weight: bold;
        }
        
        .mapping-arrow {
            margin: 0 10px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="status" id="status">Loading...</div>
    
    <div class="container">
        <div class="header">
            <h1>üîê Spacing Consistency Test</h1>
            <p>Testing encrypted text with consistent spacing</p>
        </div>
        
        <div class="content">
            <div class="test-section">
                <h2>Test 1: Normal Paragraph</h2>
                <p>This is quark a normal paragraph with regular spacing between words. The quick brown fox jumps over the lazy dog. Each word should have consistent spacing, and the text should flow naturally without any large gaps or cramped spacing between words.</p>
            </div>
            
            <div class="test-section">
                <h2>Test 2: Long Words and Spaces</h2>
                <p>Development implementation architecture infrastructure documentation configuration. These long words should maintain proper spacing. The spaces between words should be uniform and consistent throughout the entire paragraph.</p>
            </div>
            
            <div class="test-section">
                <h2>Test 3: Mixed Content</h2>
                <p>Here is some text with various word lengths: I, a, the, quick, development, implementation, supercalifragilisticexpialidocious. All spaces should be the same width regardless of the words around them.</p>
            </div>
            
            <div class="test-section">
                <h2>Test 4: Technical Terms</h2>
                <p>API endpoint encryption decryption font generation metrics preservation. Technical terminology should not affect spacing. Each space character should have identical width.</p>
            </div>
            
            <div class="test-section">
                <h2>Test 5: Repetitive Text</h2>
                <p>Word word word word word word word word word word. This repetitive text helps identify spacing inconsistencies. If spacing is correct, all gaps should look identical.</p>
            </div>
            
            <div class="test-section">
                <h2>Spacing Verification</h2>
                <div class="spacing-test">
                    <p><strong>Instructions:</strong> Check that all spaces between words are uniform. There should be no:</p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Large gaps (big spaces)</li>
                        <li>Small gaps (cramped spaces)</li>
                        <li>Inconsistent spacing between different words</li>
                    </ul>
                    <p style="margin-top: 15px;"><strong>Expected:</strong> All spaces should be identical in width, matching the original font's space character width.</p>
                </div>
            </div>
            
            <div class="key-display no-encrypt">
                <div>Secret Key: <span id="secretKeyValue">Generating...</span></div>
                <div style="margin-top: 10px;">Nonce: <span id="nonceValue">Calculating...</span></div>
            </div>
            
            <div class="test-section no-encrypt">
                <h2>Character Mappings</h2>
                <div class="mappings-display no-encrypt">
                    <p><strong>Encryption Mappings:</strong> Original character ‚Üí Encrypted character</p>
                    <div id="mappingsContainer" class="no-encrypt">Loading mappings...</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Generate a random secret key (8-digit number, between 10000000 and 99999999)
        const randomSecretKey = Math.floor(10000000 + Math.random() * 90000000);
        
        // Display the generated key immediately
        document.addEventListener('DOMContentLoaded', function() {
            const keyDisplay = document.getElementById('secretKeyValue');
            if (keyDisplay) {
                keyDisplay.textContent = randomSecretKey;
            }
            
            // Show status
            const status = document.getElementById('status');
            status.textContent = `üîë Generated Secret Key: ${randomSecretKey}`;
            status.className = 'status show info';
            setTimeout(function() {
                status.className = 'status';
            }, 3000);
            
            // Fetch and display mappings
            fetchMappings(randomSecretKey);
        });
        
        async function fetchMappings(secretKey) {
            try {
                // First, get a sample text to calculate nonce
                const sampleText = document.querySelector('.test-section p').textContent;
                
                // Fetch mappings
                const response = await fetch('http://localhost:5001/api/mappings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        secret_key: secretKey,
                        text: sampleText
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Display nonce
                const nonceDisplay = document.getElementById('nonceValue');
                if (nonceDisplay) {
                    nonceDisplay.textContent = data.nonce;
                }
                
                // Display mappings
                displayMappings(data);
            } catch (error) {
                console.error('Error fetching mappings:', error);
                const container = document.getElementById('mappingsContainer');
                if (container) {
                    container.innerHTML = `<p style="color: #dc3545;">Error loading mappings: ${error.message}</p>`;
                }
            }
        }
        
        function displayMappings(data) {
            const container = document.getElementById('mappingsContainer');
            if (!container) return;
            
            let html = '<div class="mappings-grid">';
            
            // Uppercase mappings
            if (data.upper_map && Object.keys(data.upper_map).length > 0) {
                html += '<div class="mapping-group">';
                html += '<h3>Uppercase (A-Z)</h3>';
                const upperSorted = Object.entries(data.upper_map).sort((a, b) => a[0].localeCompare(b[0]));
                upperSorted.forEach(([original, encrypted]) => {
                    html += `<div class="mapping-item">`;
                    html += `<span class="mapping-char">${original}</span>`;
                    html += `<span class="mapping-arrow">‚Üí</span>`;
                    html += `<span class="mapping-char">${encrypted}</span>`;
                    html += `</div>`;
                });
                html += '</div>';
            }
            
            // Lowercase mappings
            if (data.lower_map && Object.keys(data.lower_map).length > 0) {
                html += '<div class="mapping-group">';
                html += '<h3>Lowercase + Space + Period</h3>';
                const lowerSorted = Object.entries(data.lower_map).sort((a, b) => {
                    // Sort: space first, then period, then letters
                    if (a[0] === ' ') return -1;
                    if (b[0] === ' ') return 1;
                    if (a[0] === '.') return -1;
                    if (b[0] === '.') return 1;
                    return a[0].localeCompare(b[0]);
                });
                lowerSorted.forEach(([original, encrypted]) => {
                    const origDisplay = original === ' ' ? '[space]' : original === '.' ? '[period]' : original;
                    const encDisplay = encrypted === ' ' ? '[space]' : encrypted;
                    html += `<div class="mapping-item">`;
                    html += `<span class="mapping-char">${origDisplay}</span>`;
                    html += `<span class="mapping-arrow">‚Üí</span>`;
                    html += `<span class="mapping-char">${encDisplay}</span>`;
                    html += `</div>`;
                });
                html += '</div>';
            }
            
            // Special mappings
            if (data.space_map && Object.keys(data.space_map).length > 0) {
                html += '<div class="mapping-group">';
                html += '<h3>Special Characters</h3>';
                Object.entries(data.space_map).forEach(([original, encrypted]) => {
                    const origDisplay = original === '\x00' ? '[null]' : original === '\n' ? '[newline]' : original;
                    const encDisplay = encrypted === '\x00' ? '[null]' : encrypted === '\n' ? '[newline]' : encrypted;
                    html += `<div class="mapping-item">`;
                    html += `<span class="mapping-char">${origDisplay}</span>`;
                    html += `<span class="mapping-arrow">‚Üí</span>`;
                    html += `<span class="mapping-char">${encDisplay}</span>`;
                    html += `</div>`;
                });
                html += '</div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Create script element with the random secret key
        const encryptScript = document.createElement('script');
        encryptScript.src = 'http://localhost:5001/client/encrypt-page.js';
        encryptScript.setAttribute('data-secret-key', randomSecretKey);
        
        // Load the encryption script
        document.head.appendChild(encryptScript);
    </script>
</body>
</html>

