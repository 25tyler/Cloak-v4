<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Encryption Test - Live</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .status.connected {
            background: #10b981;
            color: white;
        }
        
        .status.disconnected {
            background: #ef4444;
            color: white;
        }
        
        .status.loading {
            background: #f59e0b;
            color: white;
        }
        
        .info-box {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .info-box code {
            background: #e5e7eb;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        
        /* Ensure articles use the encrypted font when loaded */
        article {
            font-family: sans-serif; /* Fallback until font loads */
        }
        
        article.font-loaded {
            font-family: 'EncryptedFont', sans-serif;
        }
        
        .articles {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        article {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        
        article:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        article h2 {
            color: #1f2937;
            margin-bottom: 15px;
            font-size: 24px;
        }
        
        article p {
            color: #4b5563;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .test-controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .test-controls h2 {
            margin-bottom: 15px;
            color: #333;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #5568d3;
        }
        
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .console {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .console .log {
            margin-bottom: 5px;
        }
        
        .console .error {
            color: #ef4444;
        }
        
        .console .success {
            color: #10b981;
        }
        
        .console .info {
            color: #3b82f6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ”’ Article Encryption API Test</h1>
            <p>Testing live API: <code>https://cloak-v3-707b7c7f67b3.herokuapp.com</code></p>
            <div id="status" class="status loading">Checking API connection...</div>
            <div class="info-box">
                <strong>Note:</strong> This page tests your deployed API. Articles below will be automatically encrypted when the page loads.
                The text will look normal due to the custom font, but it's actually encrypted!<br><br>
                <strong>Font Status:</strong> <span id="fontStatus">Loading...</span>
            </div>
        </div>
        
        <div class="test-controls">
            <h2>Test Controls</h2>
            <button onclick="testAPI()">Test API Directly</button>
            <button onclick="testBatchAPI()">Test Batch API</button>
            <button onclick="reloadArticles()">Reload Articles</button>
            <button onclick="clearConsole()">Clear Console</button>
            <div id="console" class="console"></div>
        </div>
        
        <div class="articles">
            <article>
                <h2>Breaking News: Technology Update</h2>
                <p>The quick brown fox jumps over the lazy dog. This is a test article to demonstrate the encryption system working in real-time.</p>
                <p>All text in this article will be automatically encrypted when the page loads. The encryption happens server-side using your exact algorithm.</p>
            </article>
            
            <article>
                <h2>Science Discovery</h2>
                <p>Scientists have made a groundbreaking discovery in the field of quantum computing. The new technology promises to revolutionize how we process information.</p>
                <p>This article contains multiple paragraphs to test batch encryption capabilities. Each paragraph is processed and encrypted separately.</p>
            </article>
            
            <article>
                <h2>World News Update</h2>
                <p>International leaders met today to discuss global climate initiatives. The summit brought together representatives from over 50 countries.</p>
                <p>Discussions focused on renewable energy, carbon reduction targets, and sustainable development goals for the next decade.</p>
            </article>
            
            <article>
                <h2>Sports Highlights</h2>
                <p>The championship game ended in an exciting overtime victory. Fans celebrated throughout the night as their team secured the title.</p>
                <p>This victory marks the third consecutive championship for the team, setting a new record in the league's history.</p>
            </article>
            
            <article>
                <h2>Business News</h2>
                <p>Stock markets reached new highs today as investors responded positively to economic indicators. Technology stocks led the gains.</p>
                <p>Analysts predict continued growth in the coming quarters, driven by innovation and strong consumer demand.</p>
            </article>
            
            <article>
                <h2>Entertainment Update</h2>
                <p>A new blockbuster movie premiered this weekend, breaking box office records. Critics praised the film's innovative storytelling.</p>
                <p>The film's success demonstrates the continued appeal of quality cinema in the streaming era.</p>
            </article>
        </div>
    </div>
    
    <script>
        const API_URL = 'https://cloak-v3-707b7c7f67b3.herokuapp.com';
        const consoleDiv = document.getElementById('console');
        const statusDiv = document.getElementById('status');
        
        function log(message, type = 'log') {
            const logEntry = document.createElement('div');
            logEntry.className = `log ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            consoleDiv.appendChild(logEntry);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        function clearConsole() {
            consoleDiv.innerHTML = '';
        }
        
        // Test API connection
        async function checkAPI() {
            try {
                const response = await fetch(`${API_URL}/api/health`);
                const data = await response.json();
                if (data.status === 'healthy') {
                    statusDiv.textContent = 'âœ… API Connected';
                    statusDiv.className = 'status connected';
                    log('API health check passed', 'success');
                    return true;
                }
            } catch (error) {
                statusDiv.textContent = 'âŒ API Disconnected';
                statusDiv.className = 'status disconnected';
                log(`API health check failed: ${error.message}`, 'error');
                return false;
            }
        }
        
        // Test encryption API directly
        async function testAPI() {
            log('Testing encryption API...', 'info');
            try {
                const response = await fetch(`${API_URL}/api/encrypt`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: 'Hello World' })
                });
                
                const data = await response.json();
                log(`API Response: ${JSON.stringify(data)}`, 'success');
                log(`Original: "Hello World"`, 'info');
                log(`Encrypted: "${data.encrypted}"`, 'info');
                log(`Font URL: ${data.font_url}`, 'info');
            } catch (error) {
                log(`API Test Failed: ${error.message}`, 'error');
            }
        }
        
        // Test batch API
        async function testBatchAPI() {
            log('Testing batch encryption API...', 'info');
            try {
                const response = await fetch(`${API_URL}/api/encrypt/batch`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        texts: ['Hello', 'World', 'Test'] 
                    })
                });
                
                const data = await response.json();
                log(`Batch API Response: ${JSON.stringify(data)}`, 'success');
                log(`Encrypted ${data.encrypted.length} texts`, 'info');
                data.encrypted.forEach((enc, i) => {
                    log(`  [${i}]: "${enc}"`, 'info');
                });
            } catch (error) {
                log(`Batch API Test Failed: ${error.message}`, 'error');
            }
        }
        
        // Reload articles (re-encrypt)
        function reloadArticles() {
            log('Reloading articles...', 'info');
            window.location.reload();
        }
        
        // Monitor encryption process
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const url = args[0];
            if (typeof url === 'string' && url.includes('/api/encrypt')) {
                log(`API Call: ${args[1]?.method || 'GET'} ${url}`, 'info');
                return originalFetch.apply(this, args)
                    .then(response => {
                        log(`API Response: ${response.status} ${response.statusText}`, 'success');
                        return response;
                    })
                    .catch(error => {
                        log(`API Error: ${error.message}`, 'error');
                        throw error;
                    });
            }
            return originalFetch.apply(this, args);
        };
        
        // Initialize
        checkAPI();
        
        // Preload the font first
        async function loadFont() {
            // Try local font first (most reliable for testing)
            try {
                log('Loading local font...', 'info');
                // Add cache-busting parameter to force reload
                const fontUrl = `fonts/encrypted.woff2?t=${Date.now()}`;
                const localFont = new FontFace('EncryptedFont', `url(${fontUrl})`);
                await localFont.load();
                document.fonts.add(localFont);
                
                // Apply font to all articles
                document.querySelectorAll('article').forEach(article => {
                    article.style.fontFamily = 'EncryptedFont, sans-serif';
                    article.classList.add('font-loaded');
                });
                
                log('Local font loaded successfully', 'success');
                document.getElementById('fontStatus').textContent = 'âœ… Loaded (Local)';
                document.getElementById('fontStatus').style.color = '#10b981';
                return true;
            } catch (localError) {
                log(`Local font failed: ${localError.message}`, 'error');
                log('Trying font from API...', 'info');
                
                // Fallback: Try to get font URL from API
                try {
                    const testResponse = await fetch(`${API_URL}/api/encrypt`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: 'test' })
                    });
                    const testData = await testResponse.json();
                    const fontUrl = testData.font_url;
                    
                    // Only use API font URL if it's a valid URL (not the app URL)
                    if (fontUrl && fontUrl.includes('.woff2') && !fontUrl.includes('herokuapp.com')) {
                        log(`Loading font from API: ${fontUrl}`, 'info');
                        const font = new FontFace('EncryptedFont', `url(${fontUrl})`);
                        await font.load();
                        document.fonts.add(font);
                        
                        document.querySelectorAll('article').forEach(article => {
                            article.style.fontFamily = 'EncryptedFont, sans-serif';
                            article.classList.add('font-loaded');
                        });
                        
                        log('Font loaded from API successfully', 'success');
                        document.getElementById('fontStatus').textContent = 'âœ… Loaded (CDN)';
                        document.getElementById('fontStatus').style.color = '#10b981';
                        return true;
                    } else {
                        log(`API font URL invalid: ${fontUrl}`, 'error');
                        throw new Error('Invalid font URL from API');
                    }
                } catch (error) {
                    log(`Font loading failed: ${error.message}`, 'error');
                    log('Note: Text is encrypted but font is not loaded. It will look garbled.', 'error');
                    document.getElementById('fontStatus').textContent = 'âŒ Failed - Text will look garbled';
                    document.getElementById('fontStatus').style.color = '#ef4444';
                    return false;
                }
            }
        }
        
        // Load font first, then encryption script
        loadFont().then(() => {
            // Load the encryption script
            const script = document.createElement('script');
            script.src = 'client/encrypt-articles.js';
            script.async = true;
            script.onload = () => {
                log('Encryption script loaded', 'success');
                log('Articles should now be encrypted and display normally', 'success');
            };
            script.onerror = () => {
                log('Failed to load encryption script. Make sure client/encrypt-articles.js exists.', 'error');
            };
            document.head.appendChild(script);
        });
    </script>
</body>
</html>

